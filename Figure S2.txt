
# library
library(dplyr)
library(data.table)
library(ggpubr)
library(Hmisc)

# load data
load("1_All_combined_deepargByGene_df_nonReg.abundance.Rdata")

All_combined_deepargByGene_df_nonReg$res_mechanism <- capitalize(All_combined_deepargByGene_df_nonReg$res_mechanism)

# check
unique(All_combined_deepargByGene_df_nonReg$res_mechanism) 
#"antibiotic inactivation" , "multiple mechanisms", "unknown" "antibiotic efflux" , "antibiotic target alteration", "reduced permeability to antibiotic"

# 
Mech_df <- All_combined_deepargByGene_df_nonReg

Mech_df <- Mech_df %>% group_by(sampleID, res_mechanism) %>%  
  summarise(sampleType=unique(sampleType),DepthPG=sum(DepthPG))

# (2) compute percent of ARG_mechanism
totalARG_depth_df <- All_combined_deepargByGene_df_nonReg %>% group_by(sampleID) %>% summarise(DepthPG=sum(DepthPG)) %>% as.data.frame() 

Mech_df$totalARG_depth <- sapply(Mech_df$sampleID, 
                                       function(x) totalARG_depth_df$DepthPG[which(totalARG_depth_df$sampleID == x)])

Mech_df$percent <- Mech_df$DepthPG/Mech_df$totalARG_depth 

# 
Mech_df <- Mech_df %>% group_by(sampleType, res_mechanism) %>% 
  summarise(percent=mean(percent))



# plot
Mech_df$res_mechanism <- factor(Mech_df$res_mechanism, levels = c("Antibiotic inactivation", "Multiple mechanisms", 
                                                                  "Antibiotic efflux", "Antibiotic target alteration", 
                                                                  "Reduced permeability to antibiotic", "Unknown"))

Mech_df$sampleType <- factor(Mech_df$sampleType, levels = c("T", "S","Fa", "Fo","Gr","Go" ))

p1 <- ggplot(Mech_df, aes(x = sampleType, y = percent, fill=res_mechanism))  + geom_col(width = 0.6) +  
  scale_fill_manual(values = c("#9FCD99", "#0b8e36","#DFC27D", "#ce3d36", "#FFB977","gray", "gray", "#D1E5F0", "#FFB977","#B2AD8F","gray")) +
  theme(axis.text.x = element_text(hjust = 0.5, vjust = 0.5)) + 
  theme_pubr(border = T, legend = "top", base_size = 12) + 
  scale_y_continuous(expand = c(0.0001, 0.015), limits = c(0,1)) +
  scale_x_discrete(expand = c(0, 0)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5)) +
  xlab("") + ylab("Composition of ARG mechanism") + #+ guides(fill = guide_legend(nrow=2)) 
  theme(legend.position="right") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  scale_x_discrete(labels=c("Tailings", "Sewage","Farmland","Forest","Grassland","Gobi desert")) 

p1 +labs(fill="ARG mechanism")





