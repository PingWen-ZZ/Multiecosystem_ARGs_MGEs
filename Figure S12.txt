# (1) 按生境分开

# library
library(ggplot2)
library(scales)
library(ggpubr)
library(ggprism)
library(tidyverse)
library(hrbrthemes)
library(ggthemes)
library(dplyr)
library(ggpattern)
library(Hmisc)

# 
load("2_Combined_results_abundance.RData")
load("2_Ranking.RData")
load("2_significance_abundance_byARGtype.RData")

# 过滤出overall
Overall_df <- combined_df %>% filter(drug_type == "Overall")

Overall_df$sd[is.na(Overall_df$sd)] <- 0

# 
Overall_df$MGE_type_final <- factor(Overall_df$MGE_type_final, levels = c( 'IS',"Transposon",'Integron'))
Overall_df$sampleType <-  factor(Overall_df$sampleType, levels = c('Tailings','Sewage','Farmland','Forest','Grass','Gobi'))

p_total <- Overall_df  %>%
  ggplot() +
  geom_errorbar(aes(x = MGE_type_final, fill = MGE_type_final,
                    ymin = abundance_percent_mean-se, ymax = abundance_percent_mean+se),
                width = 0.5,
                colour="black", alpha=1, size=0.3) +
  geom_bar( aes(x = MGE_type_final, fill = MGE_type_final, weight = abundance_percent_mean),
            position = 'dodge',   color = NA,  width = 0.85) + 
  theme_prism(base_line_size = 0.3, border = F)  + 
  scale_fill_manual(values = c('#d0c0a5','#2e7d32' , "#dce775")) +
  scale_y_continuous(expand = c(0,0)) + # y = 0
  facet_wrap(sampleType~drug_type, nrow =2, scales = "free_y")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))+
  theme(legend.position = 'none') + xlab("") + 
  ylab("Ratio of plasmid-transposon/IS/integron-carrying ARG \n abundances to plasmid-borne ARG abundance") 
  
p_total

# 以高8宽10导出  2_plasmid_carried_Tn_IS_Integron_abundance_total

# 过滤掉overall
combined_df <- combined_df %>% filter(drug_type != "Overall")
combined_df$drug_type <- as.character(combined_df$drug_type)
combined_df$drug_type <- capitalize(combined_df$drug_type)
ARG_relAbund_df$drug_type <- capitalize(ARG_relAbund_df$drug_type)

combined_df$MGE_type_final <- factor(combined_df$MGE_type_final, 
                                     levels = c( 'IS',"Transposon",'Integron'))
combined_df$sampleType <-  factor(combined_df$sampleType, 
                                  levels = c('Tailings','Sewage','Farmland','Forest','Grass','Gobi'))
combined_df$drug_type <- factor(combined_df$drug_type, levels = ARG_relAbund_df$drug_type)

p_seperate <- combined_df %>% 
  ggplot() +
  geom_errorbar(aes(x = drug_type, fill = MGE_type_final,
                    ymin = abundance_percent_mean-se, ymax = abundance_percent_mean+se),
                stat= "identity", position = position_dodge(0.9),colour="black", alpha=1, size=0.3, width = 0.5) +
  geom_bar( aes(x = drug_type, fill = MGE_type_final, weight = abundance_percent_mean), 
            position = 'dodge',   color = NA,  width = 0.9) + 
  scale_fill_manual(values = c('#d0c0a5','#2e7d32' ,"#dce775")) + 
  facet_wrap(sampleType~., nrow =3, scales = "free_y")+
  theme_prism(base_line_size = 0.5, border = F)  + 
  theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust = 1))+ 
  theme(legend.position = 'none') + xlab("") + 
  ylab("Ratio of plasmid-transposon/IS/integron-carrying ARG \n abundances to plasmid-borne ARG abundances") +
  scale_y_continuous(expand = c(0,0)) # y = 0

p_seperate

# 以高 10 宽 20 导出  2_plasmid_carried_Tn_IS_Integron_abundance_seperate
